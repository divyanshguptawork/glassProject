<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glass AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", sans-serif;
            position: relative;
            overflow: hidden;
            background-color: #000;
        }

        .video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            filter: blur(15px);
            transition: filter 0.3s ease;
        }

        .video-background video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        body.settings-active .video-background {
            filter: blur(100px) brightness(0.5);
        }

        .container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        .glass-panel {
            backdrop-filter: blur(30px) saturate(200%);
            -webkit-backdrop-filter: blur(30px) saturate(200%);
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 24px;
            padding: 40px;
            width: 100%;
            max-width: 800px;
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            position: relative;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            height: auto;
        }

        .glass-panel.hidden {
            opacity: 0;
            visibility: hidden;
            transform: scale(0.9);
        }

        body.settings-active .glass-panel {
            backdrop-filter: blur(40px) saturate(150%);
            -webkit-backdrop-filter: blur(40px) saturate(150%);
        }

        .glass-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg,
                rgba(255,255,255,0.1) 0%,
                rgba(255,255,255,0.05) 50%,
                rgba(255,255,255,0.1) 100%);
            border-radius: 24px;
            pointer-events: none;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 3;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.85);
            letter-spacing: -0.5px;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.2);
        }

        .controls {
            display: flex;
            gap: 12px;
            position: relative;
        }

        .detach-btn, .settings-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 16px;
            color: rgba(0, 0, 0, 0.8);
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .detach-btn:hover, .settings-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .settings-btn {
            padding: 10px;
            min-width: 40px;
            justify-content: center;
        }

        .settings-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            width: 300px;
            /* Enhanced backdrop blur effect for personal context box */
            backdrop-filter: blur(50px) saturate(180%) brightness(1.2);
            -webkit-backdrop-filter: blur(50px) saturate(180%) brightness(1.2);
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.7);
            border-radius: 16px;
            padding: 20px;
            box-shadow:
                0 12px 40px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            transform-origin: top right;
            transform: scale(0.95);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease-in-out;
            z-index: 5;
        }

        /* Additional backdrop blur layer for enhanced effect */
        .settings-dropdown::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(80px) saturate(200%) brightness(1.1);
            -webkit-backdrop-filter: blur(80px) saturate(200%) brightness(1.1);
            border-radius: 18px;
            z-index: -1;
        }

        /* Even more blur when active */
        body.settings-active .settings-dropdown {
            backdrop-filter: blur(60px) saturate(200%) brightness(1.3);
            -webkit-backdrop-filter: blur(60px) saturate(200%) brightness(1.3);
        }

        body.settings-active .settings-dropdown::before {
            backdrop-filter: blur(100px) saturate(250%) brightness(1.2);
            -webkit-backdrop-filter: blur(100px) saturate(250%) brightness(1.2);
        }

        .settings-dropdown.active {
            transform: scale(1);
            opacity: 1;
            visibility: visible;
        }

        .settings-dropdown h3 {
            font-size: 1.2rem;
            color: rgba(0, 0, 0, 0.9);
            margin-bottom: 15px;
            font-weight: 700;
            position: relative;
            z-index: 1;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        .settings-dropdown label {
            display: block;
            font-size: 0.9rem;
            color: rgba(0, 0, 0, 0.8);
            margin-bottom: 8px;
            font-weight: 500;
            position: relative;
            z-index: 1;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        .settings-dropdown textarea {
            width: 100%;
            height: 100px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(20px) brightness(1.1);
            -webkit-backdrop-filter: blur(20px) brightness(1.1);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            padding: 10px;
            color: rgba(0, 0, 0, 0.9);
            font-family: inherit;
            font-size: 0.9rem;
            resize: none;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .settings-dropdown textarea:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.5);
        }

        .settings-dropdown .save-btn {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.95);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .settings-dropdown .save-btn:hover {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .chat-history {
            flex-grow: 1;
            border-radius: 20px;
            padding: 25px;
            margin-top: 10px;
            min-height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 2;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            word-wrap: break-word;
            max-width: 85%;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .chat-message.user {
            background: rgba(0, 0, 0, 0.15);
            color: rgba(0, 0, 0, 0.9);
            align-self: flex-end;
            border-bottom-right-radius: 6px;
        }

        .chat-message.ai {
            background: rgba(255, 255, 255, 0.15);
            color: rgba(0, 0, 0, 0.85);
            align-self: flex-start;
            animation: fadeIn 0.5s ease-in-out;
            border-bottom-left-radius: 6px;
        }

        .chat-message.ai.initial-message {
            align-self: center;
            text-align: center;
            font-weight: 500;
            font-size: 1.1rem;
            line-height: 1.4;
            padding: 20px;
            max-width: 90%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 18px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading {
            text-align: center;
            color: rgba(0, 0, 0, 0.6);
            font-style: italic;
            position: relative;
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 18px;
            border-radius: 18px;
            border-bottom-left-radius: 6px;
        }

        .loading::after {
            content: '...';
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .file-input-container {
            margin-top: 20px;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }

        .chat-input-area {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            position: relative;
            z-index: 2;
        }

        .chat-input {
            flex-grow: 1;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            padding: 12px 20px;
            color: rgba(0, 0, 0, 0.9);
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            overflow: hidden;
            height: 48px;
            max-height: 150px;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }

        .chat-input::placeholder {
            color: rgba(0, 0, 0, 0.5);
        }

        .send-button, .file-input-wrapper, .action-button {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            font-family: inherit;
        }

        .send-button {
            padding: 12px 20px;
            height: 48px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-input-wrapper {
            position: relative;
            display: block;
            overflow: hidden;
            padding: 20px;
            text-align: center;
            flex-grow: 1;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }

        .action-button {
            flex: 1;
            padding: 16px 20px;
            text-align: center;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 52px;
        }

        .send-button:hover, .file-input-wrapper:hover, .action-button:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .action-button:active {
            transform: translateY(0);
            background: rgba(255, 255, 255, 0.3);
        }

        .action-button.listening {
            background: rgba(74, 144, 226, 0.3);
            border-color: rgba(74, 144, 226, 0.5);
            color: rgba(0, 0, 0, 0.9);
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            left: 0;
            top: 0;
        }

        .file-input-text {
            color: rgba(0, 0, 0, 0.6);
            font-size: 1rem;
            font-weight: 500;
            pointer-events: none;
        }

        .status-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        .status-indicator.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .status-content {
            display: flex;
            align-items: center;
            gap: 12px;
            color: rgba(0, 0, 0, 0.8);
            font-size: 14px;
            font-weight: 500;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-top: 2px solid rgba(0, 0, 0, 0.8);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .floating-show-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            color: rgba(0, 0, 0, 0.8);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
        }

        .floating-show-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .glass-panel {
                padding: 25px;
                margin: 10px;
            }
            .title {
                font-size: 2rem;
            }
            .header {
                flex-direction: column;
                gap: 15px;
                align-items: center;
            }
            .action-buttons {
                flex-direction: column;
            }
            .action-button {
                flex: none;
            }
            .chat-input-area {
                flex-direction: column;
                align-items: stretch;
            }
            .send-button {
                width: 100%;
                justify-content: center;
            }
            .floating-show-button {
                bottom: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="video-background">
        <video src="https://framerusercontent.com/assets/Su0b67K1yvEHytU1XNv0tDhKkPw.mp4" loop muted playsinline autoplay poster="https://framerusercontent.com/images/WcDJkVAlonlL1ezrahcd7l58aCg.png"></video>
    </div>

    <div class="container">
        <div class="glass-panel" id="glass-panel">
            <div class="header">
                <h1 class="title">Glass AI</h1>
                <div class="controls">
                    <button id="detach-btn" class="detach-btn" title="Detach Interface">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z"/>
                        </svg>
                        Detach
                    </button>
                    <button id="settings-btn" class="settings-btn" title="Settings">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M10,22C9.75,22 9.54,21.82 9.5,21.58L9.13,18.93C8.5,18.68 7.96,18.34 7.44,17.94L4.95,18.95C4.73,19.03 4.46,18.95 4.34,18.73L2.34,15.27C2.21,15.05 2.27,14.78 2.46,14.63L4.57,12.97L4.5,12L4.57,11L2.46,9.37C2.27,9.22 2.21,8.95 2.34,8.73L4.34,5.27C4.46,5.05 4.73,4.96 4.95,5.05L7.44,6.05C7.96,5.66 8.5,5.32 9.13,5.07L9.5,2.42C9.54,2.18 9.75,2 10,2H14C14.25,2 14.46,2.18 14.5,2.42L14.87,5.07C15.5,5.32 16.04,5.66 16.56,6.05L19.05,5.05C19.27,4.96 19.54,5.05 19.66,5.27L21.66,8.73C21.79,8.95 21.73,9.22 21.54,9.37L19.43,11L19.5,12L19.43,13L21.54,14.63C21.73,14.78 21.79,15.05 21.66,15.27L19.66,18.73C19.54,18.95 19.27,19.04 19.05,18.95L16.56,17.95C16.04,18.34 15.5,18.68 14.87,18.93L14.5,21.58C14.46,21.82 14.25,22 14,22H10M11.25,4L10.88,6.61C9.68,6.86 8.62,7.5 7.85,8.39L5.44,7.35L4.69,8.65L6.8,10.2C6.4,11.37 6.4,12.64 6.8,13.8L4.68,15.36L5.43,16.66L7.86,15.62C8.63,16.5 9.68,17.14 10.87,17.38L11.24,20H12.76L13.13,17.39C14.32,17.14 15.37,16.5 16.14,15.62L18.57,16.66L19.32,15.36L17.2,13.81C17.6,12.64 17.6,11.37 17.2,10.2L19.31,8.65L18.56,7.35L16.15,8.39C15.38,7.5 14.32,6.86 13.12,6.62L12.75,4H11.25Z"/>
                        </svg>
                    </button>
                    <div id="settings-dropdown" class="settings-dropdown">
                        <h3>Personal Context</h3>
                        <label for="personal-context">Tell the AI about yourself to tailor responses.</label>
                        <textarea id="personal-context" placeholder="e.g., 'My name is John. I like a chill, funny, and slightly sarcastic tone.'"></textarea>
                        <button class="save-btn">Save</button>
                    </div>
                </div>
            </div>

            <div class="chat-history" id="chatHistory">
                <div class="chat-message ai initial-message">
                    Hello! I'm Glass. Upload images, take screenshots, or use voice commands to get started.
                </div>
            </div>

            <div class="action-buttons">
                <button id="listen-btn" class="action-button" title="Listen">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
                    </svg>
                    Listen
                </button>
                <button id="ask-btn" class="action-button" title="Ask">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"/>
                    </svg>
                    Ask
                </button>
                <button id="hide-btn" class="action-button" title="Show/Hide">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C17,4.5 21.27,7.61 23,12C21.27,16.39 17,19.5 12,19.5C7,19.5 2.73,16.39 1,12C2.73,7.61 7,4.5 12,4.5M3.18,12C4.84,15.11 8.24,17.5 12,17.5C15.76,17.5 19.16,15.11 20.82,12C19.16,8.89 15.76,6.5 12,6.5C8.24,6.5 4.84,8.89 3.18,12Z"/>
                    </svg>
                    Hide
                </button>
            </div>

            <form id="glassForm" enctype="multipart/form-data">
                <div class="file-input-container">
                    <label class="file-input-wrapper">
                        <input type="file" id="file-input" name="images" class="file-input" accept="image/*" multiple>
                        <div class="file-input-text">
                            <span id="fileText">Choose images to analyze</span>
                        </div>
                    </label>
                </div>

                <div class="chat-input-area">
                    <textarea class="chat-input" id="chat-input" name="user_query" placeholder="Ask me something about the images..." rows="1"></textarea>
                    <button type="submit" class="send-button">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                        </svg>
                        Send
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="status-indicator" class="status-indicator">
        <div class="status-content">
            <div class="spinner"></div>
            <span id="status-text">Processing...</span>
        </div>
    </div>

    <button id="floating-show-button" class="floating-show-button">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C17,4.5 21.27,7.61 23,12C21.27,16.39 17,19.5 12,19.5C7,19.5 2.73,16.39 1,12C2.73,7.61 7,4.5 12,4.5M3.18,12C4.84,15.11 8.24,17.5 12,17.5C15.76,17.5 19.16,15.11 20.82,12C19.16,8.89 15.76,6.5 12,6.5C8.24,6.5 4.84,8.89 3.18,12Z"/>
        </svg>
        Show Interface
    </button>

    <script>
        class GlassAI {
            constructor() {
                this.isListening = false;
                this.recognition = null;
                this.screenshotData = null;
                this.personalContext = '';
                this.init();
            }

            init() {
                this.glassPanel = document.getElementById('glass-panel');
                this.fileInput = document.getElementById('file-input');
                this.fileText = document.getElementById('fileText');
                this.glassForm = document.getElementById('glassForm');
                this.chatHistory = document.getElementById('chatHistory');
                this.chatInput = document.getElementById('chat-input');
                this.sendButton = document.querySelector('.send-button');

                this.detachBtn = document.getElementById('detach-btn');
                this.settingsBtn = document.getElementById('settings-btn');
                this.settingsDropdown = document.getElementById('settings-dropdown');
                this.personalContextInput = document.getElementById('personal-context');
                this.saveSettingsBtn = document.querySelector('.settings-dropdown .save-btn');

                this.listenBtn = document.getElementById('listen-btn');
                this.askBtn = document.getElementById('ask-btn');
                this.hideBtn = document.getElementById('hide-btn');
                this.floatingShowBtn = document.getElementById('floating-show-button');

                this.statusIndicator = document.getElementById('status-indicator');
                this.statusText = document.getElementById('status-text');

                this.setupEventListeners();
                this.initSpeechRecognition();
                this.loadPersonalContext();
            }

            setupEventListeners() {
                this.fileInput.addEventListener('change', (e) => this.handleFileChange(e));
                this.chatInput.addEventListener('input', () => this.autoResizeInput());
                this.chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.handleSubmit(e);
                    }
                });

                this.glassForm.addEventListener('submit', (e) => this.handleSubmit(e));

                this.detachBtn.addEventListener('click', () => this.openDetachedMode());
                this.settingsBtn.addEventListener('click', () => this.toggleSettingsDropdown());
                this.saveSettingsBtn.addEventListener('click', () => this.savePersonalContext());

                this.listenBtn.addEventListener('click', () => this.handleVoiceAndScreenshot());
                this.askBtn.addEventListener('click', () => this.handleAskWithScreenshot());
                this.hideBtn.addEventListener('click', () => this.handleShowHide());
                this.floatingShowBtn.addEventListener('click', () => this.handleShowHide());

                document.addEventListener('click', (e) => {
                    if (!this.settingsBtn.contains(e.target) && !this.settingsDropdown.contains(e.target)) {
                        this.settingsDropdown.classList.remove('active');
                        document.body.classList.remove('settings-active');
                    }
                });
            }

            toggleSettingsDropdown() {
                this.settingsDropdown.classList.toggle('active');
                document.body.classList.toggle('settings-active');
            }

            loadPersonalContext() {
                // Load personal context from server or localStorage as fallback
                const saved = localStorage.getItem('glassai-personal-context');
                if (saved) {
                    this.personalContext = saved;
                    this.personalContextInput.value = saved;
                }
            }

            savePersonalContext() {
                const context = this.personalContextInput.value.trim();
                this.personalContext = context;
                localStorage.setItem('glassai-personal-context', context);

                // Also save to server
                fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        personal_context: context
                    })
                }).catch(error => {
                    console.warn('Could not save settings to server:', error);
                });

                if (context) {
                    this.showStatus('Your context has been saved!', 3000);
                } else {
                    this.showStatus('Personal context cleared.', 3000);
                }
                this.settingsDropdown.classList.remove('active');
                document.body.classList.remove('settings-active');
            }

            initSpeechRecognition() {
                if ('webkitSpeechRecognition' in window) {
                    this.recognition = new webkitSpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'en-US';

                    this.recognition.onstart = () => {
                        this.isListening = true;
                        this.listenBtn.classList.add('listening');
                        this.showStatus('Listening... Speak now');
                    };

                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        this.chatInput.value = transcript;
                        this.autoResizeInput();
                        setTimeout(() => {
                            this.handleSubmit(new Event('submit'));
                        }, 100);
                    };

                    this.recognition.onerror = (event) => {
                        this.showStatus('Speech recognition error: ' + event.error, 3000);
                        this.stopListening();
                    };

                    this.recognition.onend = () => {
                        this.stopListening();
                    };
                }
            }

            handleFileChange(e) {
                if (e.target.files.length > 0) {
                    this.fileText.textContent = `${e.target.files.length} file(s) selected`;
                } else {
                    this.fileText.textContent = 'Choose images to analyze';
                }
            }

            autoResizeInput() {
                this.chatInput.style.height = 'auto';
                this.chatInput.style.height = `${Math.min(this.chatInput.scrollHeight, 150)}px`;
            }

            async handleSubmit(e) {
                e.preventDefault();

                const userQuery = this.chatInput.value.trim();
                const files = this.fileInput.files;

                if (!userQuery && files.length === 0 && !this.screenshotData) {
                    return;
                }

                if (userQuery) {
                    this.addMessage(userQuery, 'user');
                }

                this.setInputsDisabled(true);
                const loadingDiv = this.addMessage('Thinking...', 'ai loading');

                try {
                    let imageData = null;

                    // Handle file upload
                    if (files.length > 0) {
                        const file = files[0];
                        imageData = await this.fileToBase64(file);
                    } else if (this.screenshotData) {
                        imageData = this.screenshotData;
                    }

                    await this.sendRequestToAI(userQuery, imageData, loadingDiv);

                } catch (error) {
                    console.error('Submit error:', error);
                    loadingDiv.remove();
                    this.addMessage('Sorry, something went wrong. Please try again.', 'ai');
                } finally {
                    this.clearForm();
                    this.setInputsDisabled(false);
                    this.screenshotData = null;
                }
            }

            async fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const base64 = event.target.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            async sendRequestToAI(query, screenshot_data, loadingDiv) {
                try {
                    console.log('Sending request to AI...', {
                        hasQuery: !!query,
                        hasScreenshot: !!screenshot_data,
                        hasContext: !!this.personalContext
                    });

                    // Send request to Flask backend with real Gemini AI
                    const response = await fetch('/api/ask', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            query: query || '',
                            screenshot_data: screenshot_data || null,
                            personal_context: this.personalContext || ''
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('AI Response:', data);

                    loadingDiv.remove();

                    if (data.success && data.response) {
                        const aiMessageDiv = this.addMessage('', 'ai');
                        this.typeText(data.response, aiMessageDiv);
                    } else {
                        throw new Error(data.error || 'AI processing failed.');
                    }

                } catch (error) {
                    console.error('API Error:', error);
                    loadingDiv.remove();
                    this.addMessage(`Sorry, I encountered an error: ${error.message}`, 'ai');
                }
            }

            openDetachedMode() {
                this.showStatus('Detached mode would open a new window in a real implementation', 3000);
            }

            async handleAskWithScreenshot() {
                try {
                    this.showStatus('Taking screenshot...');

                    // Call the real Flask API to take a screenshot
                    const response = await fetch('/api/screenshot', {
                        method: 'POST'
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success) {
                        this.screenshotData = data.screenshot;
                        this.showStatus('Screenshot captured! What would you like to know?', 3000);
                        this.addMessage('📸 Screenshot captured! I can now see what\'s on your screen. What would you like to know about it?', 'ai');

                        // Focus the input for immediate typing
                        this.chatInput.focus();
                        this.chatInput.placeholder = 'Ask me about what you see on the screen...';
                    } else {
                        throw new Error(data.error || 'Screenshot failed');
                    }
                } catch (error) {
                    console.error('Screenshot error:', error);
                    this.showStatus('Error taking screenshot: ' + error.message, 3000);
                    this.addMessage('Sorry, I couldn\'t take a screenshot. Please try again.', 'ai');
                }
            }

            async handleVoiceAndScreenshot() {
                try {
                    this.showStatus('Taking screenshot...');

                    // First take a screenshot using real API
                    const screenshotResponse = await fetch('/api/screenshot', {
                        method: 'POST'
                    });

                    if (!screenshotResponse.ok) {
                        throw new Error(`Screenshot failed! status: ${screenshotResponse.status}`);
                    }

                    const screenshotData = await screenshotResponse.json();

                    if (screenshotData.success) {
                        this.screenshotData = screenshotData.screenshot;
                        this.showStatus('Screenshot captured! Now listening...', 2000);
                        this.addMessage('📸 Screenshot captured! Now speak your question...', 'ai');

                        // Then start listening for voice
                        setTimeout(() => {
                            this.startListening();
                        }, 500);
                    } else {
                        throw new Error(screenshotData.error || 'Screenshot capture failed');
                    }

                } catch (error) {
                    console.error('Voice + Screenshot error:', error);
                    this.showStatus('Error: ' + error.message, 3000);
                }
            }

            handleShowHide() {
                const isHidden = this.glassPanel.classList.toggle('hidden');
                this.floatingShowBtn.style.display = isHidden ? 'block' : 'none';
            }

            startListening() {
                if (this.recognition) {
                    this.recognition.start();
                } else {
                    this.showStatus('Speech recognition not supported in this browser', 3000);
                }
            }

            stopListening() {
                this.isListening = false;
                this.listenBtn.classList.remove('listening');
                this.hideStatus();
                if (this.recognition) {
                    this.recognition.stop();
                }
            }

            addMessage(content, className) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${className}`;

                if (className.includes('loading')) {
                    messageDiv.textContent = content;
                } else if (className.includes('ai')) {
                    messageDiv.innerHTML = content;
                } else {
                    messageDiv.textContent = content;
                }

                this.chatHistory.appendChild(messageDiv);
                this.chatHistory.scrollTop = this.chatHistory.scrollHeight;

                return messageDiv;
            }

            typeText(text, element) {
                let i = 0;
                const speed = 20;

                const processedText = text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>');

                const typeWriter = () => {
                    if (i < processedText.length) {
                        if (processedText.charAt(i) === '<') {
                            let tagEnd = processedText.indexOf('>', i);
                            if (tagEnd !== -1) {
                                element.innerHTML += processedText.substring(i, tagEnd + 1);
                                i = tagEnd + 1;
                            } else {
                                element.innerHTML += processedText.charAt(i);
                                i++;
                            }
                        } else {
                            element.innerHTML += processedText.charAt(i);
                            i++;
                        }
                        element.parentElement.scrollTop = element.parentElement.scrollHeight;
                        setTimeout(typeWriter, speed);
                    }
                };
                typeWriter();
            }

            setInputsDisabled(disabled) {
                this.chatInput.disabled = disabled;
                this.fileInput.disabled = disabled;
                this.sendButton.disabled = disabled;
                this.listenBtn.disabled = disabled;
                this.askBtn.disabled = disabled;
            }

            clearForm() {
                this.chatInput.value = '';
                this.fileInput.value = '';
                this.fileText.textContent = 'Choose images to analyze';
                this.chatInput.style.height = 'auto';

                // Reset placeholder when not in screenshot mode
                if (!this.screenshotData) {
                    this.chatInput.placeholder = 'Ask me something about the images...';
                }
            }

            showStatus(message, duration = null) {
                this.statusText.textContent = message;
                this.statusIndicator.classList.add('visible');

                if (duration) {
                    setTimeout(() => this.hideStatus(), duration);
                }
            }

            hideStatus() {
                this.statusIndicator.classList.remove('visible');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.glassAI = new GlassAI();
        });
    </script>
</body>
</html>